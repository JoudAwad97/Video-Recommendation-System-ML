# =============================================================================
# Video Recommendation System - Local Development Environment
# =============================================================================
#
# Start all services:
#   docker-compose up -d
#
# Start specific services:
#   docker-compose up redis dynamodb -d
#
# View logs:
#   docker-compose logs -f
#
# Stop services:
#   docker-compose down
#
# Reset data:
#   docker-compose down -v
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # DynamoDB Local
  # ===========================================================================
  dynamodb:
    image: amazon/dynamodb-local:latest
    container_name: video-rec-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"
    volumes:
      - dynamodb-data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # Redis (Cache)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: video-rec-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # LocalStack (S3, etc.)
  # ===========================================================================
  localstack:
    image: localstack/localstack:latest
    container_name: video-rec-localstack
    ports:
      - "4566:4566"  # LocalStack edge port
    environment:
      - SERVICES=s3,secretsmanager
      - DEBUG=0
      - DATA_DIR=/tmp/localstack/data
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - localstack-data:/tmp/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # Lambda (Local)
  # ===========================================================================
  lambda:
    build:
      context: .
      dockerfile: deployment/docker/Dockerfile.lambda
    container_name: video-rec-lambda
    ports:
      - "8080:8080"
    environment:
      - ENVIRONMENT=local
      - LOG_LEVEL=DEBUG
      - LOG_FORMAT=text
      - AWS_REGION=us-east-2
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
      - DYNAMODB_ENDPOINT=http://dynamodb:8000
      - USER_FEATURES_TABLE=video-rec-user-features
      - VIDEO_FEATURES_TABLE=video-rec-video-features
      - RECOMMENDATIONS_CACHE_TABLE=video-rec-cache
      - USE_REDIS=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MODEL_BUCKET=video-rec-models
      - VECTOR_STORE_TYPE=in_memory
    depends_on:
      dynamodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
    volumes:
      - ./data:/app/data:ro
      - ./models:/opt/ml/model:ro
      - ./artifacts:/opt/ml/artifacts:ro

  # ===========================================================================
  # Setup Service (Creates tables, buckets, etc.)
  # ===========================================================================
  setup:
    image: amazon/aws-cli:latest
    container_name: video-rec-setup
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-2
    depends_on:
      dynamodb:
        condition: service_healthy
      localstack:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Creating DynamoDB tables..."

        # User features table
        aws dynamodb create-table \
          --table-name video-rec-user-features \
          --attribute-definitions AttributeName=user_id,AttributeType=N \
          --key-schema AttributeName=user_id,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST \
          --endpoint-url http://dynamodb:8000 2>/dev/null || true

        # Video features table
        aws dynamodb create-table \
          --table-name video-rec-video-features \
          --attribute-definitions AttributeName=video_id,AttributeType=N \
          --key-schema AttributeName=video_id,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST \
          --endpoint-url http://dynamodb:8000 2>/dev/null || true

        # Cache table
        aws dynamodb create-table \
          --table-name video-rec-cache \
          --attribute-definitions AttributeName=cache_key,AttributeType=S \
          --key-schema AttributeName=cache_key,KeyType=HASH \
          --billing-mode PAY_PER_REQUEST \
          --endpoint-url http://dynamodb:8000 2>/dev/null || true

        echo "Creating S3 buckets..."

        # S3 buckets via LocalStack
        aws s3 mb s3://video-rec-data --endpoint-url http://localstack:4566 2>/dev/null || true
        aws s3 mb s3://video-rec-models --endpoint-url http://localstack:4566 2>/dev/null || true
        aws s3 mb s3://video-rec-artifacts --endpoint-url http://localstack:4566 2>/dev/null || true

        echo "Setup complete!"

volumes:
  dynamodb-data:
  redis-data:
  localstack-data:

networks:
  default:
    name: video-rec-network
